// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Query/SingleQueryResult.html":'\x3cdiv\x3e\r\n  \x3cdiv class\x3d"features-result" data-dojo-attach-point\x3d"featuresResultDiv"\x3e\r\n    \x3cdiv class\x3d"results-number" data-dojo-attach-point\x3d"resultsNumberDiv"\x3e\r\n      \x3cspan\x3e${nls.numberFound}: \x3c/span\x3e\r\n      \x3cspan data-dojo-attach-point\x3d"numSpan"\x3e\x3c/span\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"popup-menu-button query-result-action-button" data-dojo-attach-event\x3d"click:_onBtnMenuClicked"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"results-container" data-dojo-attach-point\x3d"resultsContainer" data-dojo-attach-event\x3d"onscroll:_onResultsScroll" onselectstart\x3d"return false;"\x3e\r\n      \x3ctable data-dojo-attach-point\x3d"resultsTable" valign\x3d"top" class\x3d"results-table" data-dojo-attach-event\x3d"onclick:_onResultsTableClicked" cellpadding\x3d"0" cellspacing\x3d"0" \x3e\r\n        \x3ctbody data-dojo-attach-point\x3d"resultsTbody"\x3e\x3c/tbody\x3e\r\n      \x3c/table\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv class\x3d"related-records-section not-visible" data-dojo-attach-point\x3d"relatedRecordsResultDiv"\x3e\r\n    \x3ctable class\x3d"related-records-header"\x3e\r\n      \x3ctbody\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd class\x3d"first-td"\x3e\r\n            \x3cdiv class\x3d"back-arrow" data-dojo-attach-event\x3d"click:_onBtnRelatedBackClicked"\x3e\x3c/div\x3e\r\n          \x3c/td\x3e\r\n          \x3ctd class\x3d"middle-td"\x3e\r\n            \x3cdiv class\x3d"related-records-title jimu-ellipsis" data-dojo-attach-point\x3d"relatedTitleDiv"\x3e\x3c/div\x3e\r\n          \x3c/td\x3e\r\n          \x3ctd class\x3d"last-td"\x3e\x3c/td\x3e\r\n        \x3c/tr\x3e\r\n      \x3c/tbody\x3e\r\n    \x3c/table\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"shelter" data-dojo-type\x3d"jimu/dijit/LoadingShelter" data-dojo-props\x3d"hidden:true"\x3e\x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/Evented dojo/text!./SingleQueryResult.html dojo/_base/lang dojo/_base/query dojo/_base/html dojo/_base/array dojo/Deferred esri/lang esri/tasks/QueryTask esri/tasks/FeatureSet esri/symbols/jsonUtils esri/dijit/PopupTemplate esri/dijit/PopupRenderer esri/tasks/RelationshipQuery jimu/utils jimu/symbolUtils jimu/dijit/Message jimu/dijit/PopupMenu jimu/BaseFeatureAction jimu/LayerInfos/LayerInfos jimu/FeatureActionManager ./SingleQueryLoader ./RelatedRecordsResult jimu/dijit/LoadingShelter".split(" "),
function(w,x,y,z,A,B,e,t,f,k,p,C,D,q,E,F,G,H,n,I,J,K,L,M,N,O,P){return w([x,y,z,A],{baseClass:"single-query-result",templateString:B,singleQueryLoader:null,featureLayer:null,relatedRecordsResult:null,popupMenu:null,map:null,nls:null,currentAttrs:null,queryWidget:null,getCurrentAttrs:function(){return this.singleQueryLoader?this.singleQueryLoader.getCurrentAttrs():null},postCreate:function(){this.inherited(arguments);this.singleQueryLoader=new O(this.map,this.currentAttrs);this.popupMenu=K.getInstance();
this.featureActionManager=N.getInstance()},destroy:function(){this.queryWidget=null;var a=this.getCurrentAttrs();a&&a.query&&(a.query.resultLayer&&a.query.resultLayer.getMap()&&this.map.removeLayer(a.query.resultLayer),a.query.resultLayer=null);this.inherited(arguments)},zoomToLayer:function(){var a=this.getCurrentAttrs(),c=a.query.resultLayer;c&&!this._isTable(a.layerInfo)&&(a=k.filter(c.graphics,e.hitch(this,function(a){return!!a.geometry})),0<a.length&&(a=n.graphicsExtent(a,1.4))&&this.map.setExtent(a))},
executeQueryForFirstTime:function(){var a=new p;this._clearResultPage();this._hideResultsNumberDiv();var c=this.getCurrentAttrs(),b=c.query.resultLayer,d=e.hitch(this,function(d){if(this.domNode){this.shelter.hide();var e=c.query.allCount;this._updateNumSpan(e);0<e&&(this._addResultItems(d,b),this._addResultLayerToMap(b));a.resolve(e)}}),g=e.hitch(this,function(c){console.error(c);this.domNode&&(this.shelter.hide(),b&&this.map.removeLayer(b),b=null,this._showQueryErrorMsg(),a.reject(c))});this.shelter.show();
3!==c.queryType&&this._showResultsNumberDiv();this.singleQueryLoader.executeQueryForFirstTime().then(d,g);return a},_addResultLayerToMap:function(a){0>this.map.graphicsLayerIds.indexOf(a.id)&&this.map.addLayer(a)},_showResultsNumberDiv:function(){f.setStyle(this.resultsNumberDiv,"display","block")},_hideResultsNumberDiv:function(){f.setStyle(this.resultsNumberDiv,"display","none")},_updateNumSpan:function(a){this.numSpan.innerHTML=n.localizeNumber(a)},_isTable:function(a){return"Table"===a.type},
_onResultsScroll:function(){if(n.isScrollToBottom(this.resultsContainer)){var a=this.getCurrentAttrs();if(!(a.query.nextIndex>=a.query.allCount)){var c=a.query.resultLayer,a=e.hitch(this,function(a){this.domNode&&(this.shelter.hide(),this._addResultItems(a,c))}),b=e.hitch(this,function(a){console.error(a);this.domNode&&(this._showQueryErrorMsg(),this.shelter.hide())});this.shelter.show();this.singleQueryLoader.executeQueryWhenScrollToBottom().then(a,b)}}},_clearResultPage:function(){this._hideInfoWindow();
this._unSelectResultTr();f.empty(this.resultsTbody);this._updateNumSpan(0)},_unSelectResultTr:function(){this.resultTr&&f.removeClass(this.resultTr,"jimu-state-active");this.resultTr=null},_selectResultTr:function(a){this._unSelectResultTr();(this.resultTr=a)&&f.addClass(this.resultTr,"jimu-state-active")},_addResultItems:function(a,c){var b=this.getCurrentAttrs(),d=null,g=b.config.url,f=b.config.objectIdField;b.config.resultsSymbol&&(d=E.fromJson(b.config.resultsSymbol));var h=this._getCurrentRelationships(),
l=e.clone(b.config.popupInfo);l.mediaInfos=[];var m=new F(l),r=!0;c.renderer||(r=!1);k.forEach(a,e.hitch(this,function(a,e){var l="",l=0===e%2?"even":"odd";a.geometry&&d&&a.setSymbol(d);c.add(a);this._createQueryResultItem({resultLayer:c,feature:a,trClass:l,popupTemplate2:m,relationships:h,objectIdField:f,url:g,relationshipPopupTemplates:b.relationshipPopupTemplates,shouldCreateSymbolNode:r})}));this.zoomToLayer()},_createQueryResultItem:function(a){var c=a.resultLayer,b=a.feature,d=a.trClass,g=a.popupTemplate2,
s=a.relationships,h=a.objectIdField,l=a.url,m=a.relationshipPopupTemplates;a=a.shouldCreateSymbolNode;if(b&&b.attributes){var r=b.attributes[h],h=f.toDom('\x3ctr class\x3d"jimu-table-row jimu-table-row-separator query-result-item"  cellpadding\x3d"0" cellspacing\x3d"0"\x3e\x3ctd\x3e\x3ctable class\x3d"query-result-item-table"\x3e\x3ctbody\x3e\x3ctr\x3e\x3ctd class\x3d"symbol-td"\x3e\x3c/td\x3e\x3ctd class\x3d"popup-td"\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/tbody\x3e\x3c/table\x3e\x3c/td\x3e\x3c/tr\x3e');
f.addClass(h,d);f.place(h,this.resultsTbody);h.feature=b;d=t(".symbol-td",h)[0];if(a)try{var n=c.renderer;if(n){var u=n.getSymbol(b);if(u){var p=I.createSymbolNode(u,{width:32,height:32});p&&f.place(p,d)}}}catch(q){console.error(q)}else f.destroy(d);var v=t(".popup-td",h)[0],c=new G({template:g,graphic:b,chartTheme:g.chartTheme});f.place(c.domNode,v);c.startup();s&&0<s.length&&k.forEach(s,e.hitch(this,function(a){var b=this._getRelationshipLyaerInfo(a.relatedTableId),c=b.name,e=m[a.relatedTableId],
d=f.create("div",{"class":"related-table-btn",innerHTML:c},v);d.queryStatus="unload";d.url=l;d.layerName=c;d.objectId=r;d.relationship=a;d.relationshipLayerInfo=b;d.relationshipPopupTemplate=e}))}},_onBtnRelatedBackClicked:function(){this._showFeaturesResultDiv()},_showFeaturesResultDiv:function(){this.relatedRecordsResult&&this.relatedRecordsResult.destroy();this.relatedRecordsResult=null;f.removeClass(this.featuresResultDiv,"not-visible");f.addClass(this.relatedRecordsResultDiv,"not-visible");this.emit("hide-related-records")},
_showRelatedRecordsDiv:function(){f.addClass(this.featuresResultDiv,"not-visible");f.removeClass(this.relatedRecordsResultDiv,"not-visible");this.emit("show-related-records")},_onRelatedTableButtonClicked:function(a){this.relatedRecordsResult&&this.relatedRecordsResult.destroy();this.relatedRecordsResult=null;var c=a.url,b=a.layerName,d=a.objectId,g=a.relationship,f=a.relationshipLayerInfo,h=a.relationshipPopupTemplate;this.relatedRecordsResult=new P({map:this.map,layerDefinition:f,nls:this.nls});
this.relatedRecordsResult.placeAt(this.relatedRecordsResultDiv,"first");this._showRelatedRecordsDiv();var l=e.hitch(this,function(){var c=new q;c.fields=e.clone(f.fields);c.features=a.relatedFeatures;c.geometryType=f.geometryType;c.fieldAliases={};k.forEach(c.fields,e.hitch(this,function(a){var b=a.name;c.fieldAliases[b]=a.alias||b}));this.relatedRecordsResult.setResult(h,c);this.relatedTitleDiv.innerHTML=b});if("unload"===a.queryStatus){a.queryStatus="loading";this.shelter.show();var c=new D(c),
m=new H;m.objectIds=[d];m.relationshipId=g.id;m.outFields=["*"];m.returnGeometry=!0;m.outSpatialReference=this.map.spatialReference;c.executeRelationshipQuery(m).then(e.hitch(this,function(b){this.domNode&&(this.shelter.hide(),b=(b=(b=b&&b[d])&&b.features)||[],a.relatedFeatures=b,a.queryStatus="loaded",l())}),e.hitch(this,function(b){this.domNode&&(this.shelter.hide(),console.error(b),a.queryStatus="unload",l())}))}else"loaded"===a.queryStatus&&l()},_getCurrentRelationships:function(){return this.getCurrentAttrs().queryTr.layerInfo.relationships||
[]},_getRelationshipInfo:function(a){for(var c=this._getCurrentRelationships(),b=0;b<c.length;b++)if(c[b].id===a)return c[b];return null},_getRelationshipLyaerInfo:function(a){return this.getCurrentAttrs().relationshipLayerInfos[a]},_tryLocaleNumber:function(a){var c=a;if(C.isDefined(a)&&isFinite(a))try{var b=n.localizeNumber(a);"string"===typeof b&&(c=b)}catch(d){console.error(d)}return c+""},_showQueryErrorMsg:function(a){new J({message:a||this.nls.queryError})},_onResultsTableClicked:function(a){a=
a.target||a.srcElement;if(f.isDescendant(a,this.resultsTable))if(f.hasClass(a,"related-table-btn"))this._onRelatedTableButtonClicked(a);else if(a=n.getAncestorDom(a,e.hitch(this,function(a){return f.hasClass(a,"query-result-item")}),this.resultsTbody)){this._selectResultTr(a);f.addClass(a,"jimu-state-active");var c=a.feature;if(a=c.geometry){var b=a.type,d,g=null;if("point"===b||"multipoint"===b){var k=e.hitch(this,function(){g=new p;var a=this.map.getNumLevels(),b=this.map.getLevel(),a=Math.max(b,
Math.floor(2*a/3));0<=this.map.getMaxZoom()?this.map.setLevel(a).then(e.hitch(this,function(){this.map.centerAt(d).then(e.hitch(this,function(){g.resolve()}))})):this.map.centerAt(d).then(e.hitch(this,function(){g.resolve()}))});if("point"===b)d=a,k();else if("multipoint"===b)if(1===a.points.length)d=a.getPoint(0),k();else if(1<a.points.length&&(b=a.getExtent()))b=b.expand(1.4),d=a.getPoint(0),g=this.map.setExtent(b)}else"polyline"===b?(b=a.getExtent(),b=b.expand(1.4),d=b.getCenter(),g=this.map.setExtent(b)):
"polygon"===b?(b=a.getExtent(),b=b.expand(1.4),d=b.getCenter(),g=this.map.setExtent(b)):"extent"===b&&(b=a.expand(1.4),d=b.getCenter(),g=this.map.setExtent(b));g&&g.then(e.hitch(this,function(){"function"===typeof this.map.infoWindow.setFeatures&&this.map.infoWindow.setFeatures([c]);"function"===typeof this.map.infoWindow.reposition&&this.map.infoWindow.reposition();this.map.infoWindow.show(d)}))}}},_hideInfoWindow:function(){this.map&&this.map.infoWindow&&(this.map.infoWindow.hide(),"function"===
typeof this.map.infoWindow.setFeatures&&this.map.infoWindow.setFeatures([]))},_getFeatureSet:function(){var a=this.currentAttrs.query.resultLayer,c=new q;c.fields=e.clone(a.fields);c.features=[].concat(a.graphics);c.geometryType=a.geometryType;c.fieldAliases={};k.forEach(c.fields,e.hitch(this,function(a){var d=a.name;c.fieldAliases[d]=a.alias||d}));return c},_onBtnMenuClicked:function(a){var c=f.position(a.target||a.srcElement),b=this._getFeatureSet(),d=this.getCurrentAttrs();this.featureActionManager.getSupportedActions(b,
d.query.resultLayer).then(e.hitch(this,function(a){k.forEach(a,e.hitch(this,function(a){a.data=b}));if(!d.config.enableExport){var f=["ExportToCSV","ExportToFeatureCollection","ExportToGeoJSON"];a=k.filter(a,e.hitch(this,function(a){return 0>f.indexOf(a.name)}))}a=k.filter(a,e.hitch(this,function(a){return"CreateLayer"!==a.name}));var h=new L({name:"RemoveQueryResult",iconClass:"icon-close",label:this.nls.removeThisResult,iconFormat:"svg",map:this.map,onExecute:e.hitch(this,this._removeResult)});
h.name="RemoveQueryResult";h.data=b;a.push(h);this.popupMenu.setActions(a);this.popupMenu.show(c)}))},_removeResult:function(){this.queryWidget.removeSingleQueryResult(this);this._hideInfoWindow()},_getAvailableWidget:function(a){return(a=this.queryWidget.appConfig.getConfigElementsByName(a)[0])&&a.visible?a:null},_openAttributeTable:function(){var a=this._getAvailableWidget("AttributeTable");if(a){var c=M.getInstanceSync().getLayerInfoById(this.currentAttrs.query.resultLayer.id);this.queryWidget.widgetManager.triggerWidgetOpen(a.id).then(e.hitch(this,
function(){this.queryWidget.publishData({target:"AttributeTable",layer:c})}))}}})});