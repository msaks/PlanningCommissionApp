// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Query/TaskSetting.html":'\x3cdiv\x3e\r\n  \x3ctable class\x3d"top"\x3e\r\n    \x3ctr\x3e\r\n      \x3ctd class\x3d"first-td"\x3e\r\n        \x3cdiv class\x3d"back-arrow" data-dojo-attach-event\x3d"onclick:_onBtnParamsBackClicked"\x3e\x3c/div\x3e\r\n      \x3c/td\x3e\r\n      \x3ctd class\x3d"second-td"\x3e\r\n        \x3cdiv class\x3d"task-name jimu-ellipsis" data-dojo-attach-point\x3d"taskNameDiv"\x3e\x3c/div\x3e\r\n      \x3c/td\x3e\r\n      \x3ctd class\x3d"third-td"\x3e\x3c/td\x3e\r\n    \x3c/tr\x3e\r\n  \x3c/table\x3e\r\n  \x3cdiv class\x3d"params-container" data-dojo-attach-point\x3d"paramsContainer"\x3e\r\n    \x3cdiv class\x3d"not-visible" data-dojo-attach-point\x3d"noFilterTip"\x3e${nls.noAttributeSpatialFilterTip}\x3c/div\x3e\r\n    \x3cdiv class\x3d"attributes-section" data-dojo-attach-point\x3d"attributesSectionDiv"\x3e\r\n      \x3cdiv class\x3d"first-stress attribute-filter-label"\x3e${nls.attributeCriteira}\x3c/div\x3e\r\n      \x3cdiv class\x3d"sql-div jimu-widget-note" data-dojo-attach-point\x3d"sqlDiv"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"spatial-section" data-dojo-attach-point\x3d"spatialSectionDiv"\x3e\r\n      \x3cdiv class\x3d"spearator not-visible" data-dojo-attach-point\x3d"spatialSpearator"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"first-stress spatial-filter-label"\x3e${nls.spatialFilter}\x3c/div\x3e\r\n      \x3cdiv class\x3d"spatial-filter-tip" data-dojo-attach-point\x3d"spatialFilterTip"\x3e\x3c/div\x3e\r\n      \x3cselect data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-point\x3d"spatialTypeSelect" data-dojo-attach-event\x3d"change:_onSpatialTypeSelectChanged" class\x3d"restrict-select-width" style\x3d"width:100%;box-sizing:border-box;"\x3e\x3c/select\x3e\r\n      \x3cdiv class\x3d"spatial-filter-content" data-dojo-attach-point\x3d"spatialFilterContent"\x3e\r\n        \x3cdiv class\x3d"drawing-section" data-dojo-attach-point\x3d"drawingSection"\x3e\x3c/div\x3e\r\n        \x3cdiv class\x3d"features-section" data-dojo-attach-point\x3d"featuresSection"\x3e\r\n          \x3cdiv class\x3d"relationship-section"\x3e\r\n            \x3cdiv class\x3d"second-stress relationship-tip"\x3e${nls.spatialRelationship}\x3c/div\x3e\r\n            \x3cselect data-dojo-attach-point\x3d"relationshipSelect" data-dojo-type\x3d"dijit/form/Select" class\x3d"restrict-select-width" style\x3d"width:100%;"\x3e\x3c/select\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv class\x3d"jimu-btn btn-execute" data-dojo-attach-event\x3d"onclick:_onBtnApplyClicked"\x3e${nls.execute}\x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"shelter" data-dojo-type\x3d"jimu/dijit/LoadingShelter" data-dojo-props\x3d\'hidden:true\'\x3e\x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/Evented dojo/text!./TaskSetting.html dojo/on dojo/Deferred dojo/_base/lang dojo/_base/html dojo/_base/array dojo/promise/all jimu/filterUtils jimu/dijit/FilterParameters ./utils ./SingleQueryLoader ./SpatialFilterByDrawing jimu/dijit/SpatialFilterByFeatures esri/tasks/query".split(" "),function(l,m,n,p,q,r,g,k,e,f,s,t,u,v,h,w,x,y,z){return l([m,n,p,q],{baseClass:"query-task-setting",templateString:r,
askForValues:!1,_defaultRelationship:"SPATIAL_REL_INTERSECTS",nls:null,map:null,currentAttrs:null,layerInfosObj:null,postCreate:function(){this.inherited(arguments);this._initSelf()},run:function(){var a=this._getCleanClonedCurrentAttrs(this.currentAttrs);a.query.relationship=this._getRestRelationship();var d=this.getWhere(),c=this.getGeometry();t([d,c]).then(e.hitch(this,function(b){this.deactivate();a.query.where=b[0];a.query.geometry=b[1];a.query.geometry||console.log("Don't use geometry to query.");
if("function"===typeof this.onApply)this.onApply(a)}),e.hitch(this,function(a){console.error(a)}))},_getCleanClonedCurrentAttrs:function(a){var d=w.getCleanCurrentAttrsTemplate(),c=null,b;for(b in a)"queryTr"!==b&&"query"!==b&&(c=a[b],d[b]=e.clone(c));d.queryTr=a.queryTr;return d},onGetQueryResponse:function(){this.deactivate();this._tryResetSpatialFilterByDrawing();this._tryResetSpatialFilterByFeatures()},getWhere:function(){var a=new k,d=this._getWhereInfo();if(1===d.status){var c=this.currentAttrs.config.webMapLayerId;
if(c){var b=null,b=h.isTable(this.currentAttrs.layerInfo)?this.layerInfosObj.getTableInfoById(c):this.layerInfosObj.getLayerInfoById(c),c="";b&&(c=b.getFilter());b=d.where;c&&(b="("+c+") AND ("+d.where+")");a.resolve(b)}else a.resolve(d.where)}else a.reject("Can't get a valid sql");return a},_getWhereInfo:function(){var a={status:0,where:""};if(this.askForValues){var d=this.filterParams.getFilterExpr();d&&"string"===typeof d?(a.status=1,a.where=d):(a.status=-1,a.where=null)}else a.status=1,a.where=
this.currentAttrs.config.filter.expr;1===a.status&&!a.where&&(a.where="1\x3d1");return a},getGeometry:function(){var a=new k,d=this.spatialTypeSelect.get("value");"currentMapExtent"===d?a.resolve(this.map.extent):"drawing"===d?(d=this.spatialFilterByDrawing.getGeometryInfo(),0>d.status?a.reject("Invalid search distance"):(0===d.status&&console.log("User doesn't draw anything"),a.resolve(d.geometry))):"useFeatures"===d?this.spatialFilterByFeatures.getGeometryInfo().then(e.hitch(this,function(c){-2===
c.status?a.reject("Invalid search distance"):(-1===c.status?console.log("User doesn't select a layer"):0===c.status&&console.log("User doesn't select any features"),a.resolve(c.geometry))}),e.hitch(this,function(c){a.reject(c)})):a.resolve(null);return a},deactivate:function(){this.spatialFilterByDrawing&&this.spatialFilterByDrawing.deactivate();this.spatialFilterByFeatures&&this.spatialFilterByFeatures.deactivate()},clearAllGraphics:function(){this.spatialFilterByDrawing&&this.spatialFilterByDrawing.clearAllGraphics();
this.spatialFilterByFeatures&&this.spatialFilterByFeatures.clearAllGraphics()},canAutoRunning:function(){return this._canAttributeFilterAutoRunning()&&this._canSpatialFilterAutoRunning()},_canAttributeFilterAutoRunning:function(){return 0<this._getWhereInfo().status&&!this.askForValues},_canSpatialFilterAutoRunning:function(){var a=this.spatialTypeSelect.getOptions()||[];return 0===a.length?!0:1===a.length?(a=this.spatialTypeSelect.get("value"),"drawing"!==a&&"useFeatures"!==a):!1},_initSelf:function(){var a=
this.currentAttrs.layerInfo;this.taskNameDiv.innerHTML=this.currentAttrs.config.name||"";this.taskNameDiv.title=this.taskNameDiv.innerHTML;this.filterParams=new v;this.filterParams.placeAt(this.sqlDiv,"before");var d=e.clone(this.currentAttrs.config.filter);this.filterParams.build(this.currentAttrs.config.url,this.currentAttrs.layerInfo,d);this.askForValues=(new u).isAskForValues(this.currentAttrs.config.filter);d=!0;this.askForValues?(d=!0,this.currentAttrs.config.filter.expr&&(this.sqlDiv.innerHTML=
this.currentAttrs.config.filter.expr),this.own(g(this.filterParams,"change",e.hitch(this,function(a){this.sqlDiv.innerHTML="";a&&(this.sqlDiv.innerHTML=a)})))):(d=this.currentAttrs.config.showSQL?"1\x3d1"!==this.currentAttrs.config.filter.expr:!1,this.sqlDiv.innerHTML=this.currentAttrs.config.filter.expr);this.currentAttrs.config.showSQL?f.removeClass(this.sqlDiv,"not-visible"):f.addClass(this.sqlDiv,"not-visible");d?f.removeClass(this.attributesSectionDiv,"not-visible"):f.addClass(this.attributesSectionDiv,
"not-visible");var c=this.currentAttrs.config.spatialFilter,b=null;c||(c={});h.isTable(a)&&(c={});c.currentMapExtent&&(b={value:"currentMapExtent",label:this.nls.useCurrentExtentTip},this.spatialTypeSelect.addOption(b),c.currentMapExtent["default"]&&this.spatialTypeSelect.set("value",b.value));c.drawing&&(b={value:"drawing",label:this.nls.useDrawGraphicTip},this.spatialTypeSelect.addOption(b),c.drawing["default"]&&this.spatialTypeSelect.set("value",b.value),b=c.drawing.buffer,this.spatialFilterByDrawing=
new x({drawBoxOption:{map:this.map,geoTypes:c.drawing.geometryTypes},nls:this.nls,enableBuffer:!!b,distance:e.getObject("defaultDistance",!1,b)||0,unit:e.getObject("defaultUnit",!1,b)||""}),this.spatialFilterByDrawing.placeAt(this.drawingSection));c.useFeatures&&(b={value:"useFeatures",label:this.nls.useFeaturesTip},this.spatialTypeSelect.addOption(b),c.useFeatures["default"]&&this.spatialTypeSelect.set("value",b.value),b=c.useFeatures.buffer,this.spatialFilterByFeatures=new y({map:this.map,nls:this.nls,
enableBuffer:!!b,distance:e.getObject("defaultDistance",!1,b)||0,unit:e.getObject("defaultUnit",!1,b)||"",showLoading:!1}),this.spatialFilterByFeatures.tipNode&&f.setStyle(this.spatialFilterByFeatures.tipNode,"display","block"),this.spatialFilterByFeatures.placeAt(this.featuresSection),this.own(g(this.spatialFilterByFeatures,"loading",e.hitch(this,function(){this.domNode&&this.shelter.show()}))),this.own(g(this.spatialFilterByFeatures,"unloading",e.hitch(this,function(){this.domNode&&this.shelter.hide()}))),
(b=c.useFeatures.relationships)&&0<b.length?s.forEach(b,e.hitch(this,function(a){this.relationshipSelect.addOption({value:a.relationship,label:a.label})})):this.relationshipSelect.addOption({value:this._defaultRelationship,label:this._defaultRelationship}));c.fullLayerExtent&&(b={value:"fullLayerExtent",label:this.nls.noSpatialLimitTip},this.spatialTypeSelect.addOption(b),c.fullLayerExtent["default"]&&this.spatialTypeSelect.set("value",b.value));c=!0;b=this.spatialTypeSelect.getOptions()||[];0===
b.length?(c=!1,this.spatialFilterTip.innerHTML=this.nls.noSpatialLimitTip):1===b.length?(c="fullLayerExtent"!==b[0].value,this.spatialFilterTip.innerHTML=b[0].label,f.addClass(this.spatialTypeSelect.domNode,"not-visible")):c=!0;h.isTable(a)&&(c=!1);c?f.removeClass(this.spatialSectionDiv,"not-visible"):f.addClass(this.spatialSectionDiv,"not-visible");this._onSpatialTypeSelectChanged();!d&&!c&&f.removeClass(this.noFilterTip,"not-visible")},_getConstantRelationship:function(){var a=this._defaultRelationship;
"useFeatures"===this.spatialTypeSelect.get("value")&&(a=this.relationshipSelect.get("value"));return a},_getRestRelationship:function(){var a=this._getConstantRelationship();return z[a]},_onSpatialTypeSelectChanged:function(){var a=this.spatialTypeSelect.get("value");"drawing"===a?f.setStyle(this.drawingSection,"display","block"):(f.setStyle(this.drawingSection,"display","none"),this._tryResetSpatialFilterByDrawing());"useFeatures"===a?f.setStyle(this.featuresSection,"display","block"):(f.setStyle(this.featuresSection,
"display","none"),this._tryResetSpatialFilterByFeatures());this.spatialTypeSelect.domNode.title="";if(a&&(a=this.spatialTypeSelect.getOptions(a)))this.spatialTypeSelect.domNode.title=a.label},_tryResetSpatialFilterByDrawing:function(){this.spatialFilterByDrawing&&this.spatialFilterByDrawing.reset()},_tryResetSpatialFilterByFeatures:function(){this.spatialFilterByFeatures&&this.spatialFilterByFeatures.reset()},_onBtnParamsBackClicked:function(){this._tryResetSpatialFilterByDrawing();this._tryResetSpatialFilterByFeatures();
if("function"===typeof this.onBack)this.onBack()},_onBtnApplyClicked:function(){this.run()}})});